<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mail Sender</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    padding: 10px; 
    background: #f4f6f9;
  }
  h2 {
    text-align: center;
    margin-bottom: 10px;
    color: #333;
  }
  form {
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    max-width: 500px;
    margin: auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 20px;
  }
  label {
    font-weight: bold;
    display: block;
    margin-bottom: 3px;
    color: #444;
  }
  input, select, button {
    padding: 5px;
    width: 100%;
    border: 3px solid #ccc;
    border-radius: 10px;
    font-size: 12px;
  }
  input:focus, select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0,123,255,0.4);
  }

  /* Hidden state */
  .hidden {
    display: none !important;
  }

  /* Account Details (visible state, when JS removes .hidden) */
  #accountDetails {
    grid-column: span 2;
    background: #fafafa;
    padding: 15px;
    border-radius: 8px;
    border: 2px solid #ddd;
  }
  #accountDetails.visible {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 20px;
  }
  #accountDetails h3 { 
    margin: 0 0 0.5px 0; 
    grid-column: span 2; 
    color: #007bff; 
  }
  .error { color: red; grid-column: span 2; }
  button {
    background: #007bff;
    color: white;
    font-weight: bold;
    border: none;
    cursor: pointer;
    grid-column: span 2;
    transition: 0.3s;
  }
  button:hover { background: #0056b3; }
</style>
</head>
<body>

<h2>Branch Mail Sender</h2>
<form id="mailForm">
  <div>
    <label for="mailType">Mail Type*</label>
    <select id="mailType" required>
      <option value="">Select Mail Type</option>
      <option value="Packet Hold From The Auction">Packet Hold From The Auction</option>
      <option value="Packet Availability Confirmation">Packet Availability Confirmation</option>
      <option value="Customer Query For Auction Surplus">Customer Query For Auction Surplus</option>
      <option value="Customer Query for Auction Details">Customer Query for Auction Details</option>
      <option value="Handover the DD To The Customer">Handover the DD To The Customer</option>
      <option value="Transfer of Surplus Amount To Customer">Transfer of Surplus Amount To Customer</option>
    </select>
  </div>

  <div>
    <label for="glId">GL ID*</label>
    <input type="text" id="glId" pattern="\d+" required placeholder="Enter GL ID (numbers only)">
  </div>

  <div>
    <label for="customerName">Customer Name*</label>
    <input type="text" id="customerName" pattern="[A-Za-z\s]+" required placeholder="Enter Customer Name">
  </div>

  <div>
    <label for="customerNumber">Customer Number*</label>
    <input type="text" id="customerNumber" pattern="\d+" required placeholder="Enter Customer Number">
  </div>

  <div>
    <label for="branchNameInput">Branch Name*</label>
    <input list="branchList" id="branchNameInput" required placeholder="Select or type branch">
    <datalist id="branchList">
      <option value="Test">
      <option value="blr">
    </datalist>
  </div>

  <div>
    <label for="mappedEmail">Mapped Email*</label>
    <input type="email" id="mappedEmail" readonly required placeholder="Mapped Email">
  </div>

  <div>
    <label for="regards">Regards*</label>
    <select id="regards" required>
      <option value="">Select</option>
      <option value="Arif">Arif</option>
      <option value="Sana">Sana</option>
    </select>
  </div>

  <div>
    <label for="password">Password*</label>
    <input type="password" id="password" required placeholder="Enter Password">
  </div>

  <div id="accountDetails" class="hidden">
    <h3>Account Details</h3>
    <label for="bankAccount">Bank A/C Number*</label>
    <input type="text" id="bankAccount">

    <label for="bankName">Bank Name*</label>
    <input type="text" id="bankName">

    <label for="ifsc">IFSC Code*</label>
    <input type="text" id="ifsc">

    <label for="passbook">Passbook / Cheque Leaf*</label>
    <input type="file" id="passbook">

    <label for="aadhar">Aadhar Card (optional)</label>
    <input type="file" id="aadhar">

    <label for="pan">Pan Card (optional)</label>
    <input type="file" id="pan">
  </div>

  <div class="error" id="errorMsg"></div>
  <button type="submit" id="sendMailBtn">Send Mail</button>
</form>
<script>
const branchEmails = { "Test": "vidyadhar.patil@rupeek.com", "blr": "rupeek.collections@rupeek.com" };
const regardsPasswords = { "Arif": "3834", "Sana": "1234" };

const mailType = document.getElementById('mailType');
const branchNameInput = document.getElementById('branchNameInput');
const mappedEmail = document.getElementById('mappedEmail');
const regards = document.getElementById('regards');
const password = document.getElementById('password');
const accountDetails = document.getElementById('accountDetails');
const customerNameInput = document.getElementById('customerName');
const form = document.getElementById('mailForm');
const errorMsg = document.getElementById('errorMsg');
const sendBtn = document.getElementById('sendMailBtn');

// Show/hide account details for Transfer type
mailType.addEventListener('change', () => {
  accountDetails.classList.toggle('hidden', mailType.value !== "Transfer of Surplus Amount To Customer");
});

// Map email based on branch input
branchNameInput.addEventListener('input', () => {
  mappedEmail.value = branchEmails[branchNameInput.value] || '';
});

// Auto-capitalize customer name
customerNameInput.addEventListener('input', () => {
  let words = customerNameInput.value.split(' ');
  words = words.map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase());
  customerNameInput.value = words.join(' ');
});

// Convert file to Base64
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Generate subject and body
function getEmailContent(data){
  let subject='', body=`Dear Branch Staff,<br><br>`;
  switch(data.mailType){
    case "Packet Hold From The Auction":
      subject=`Hold The Packet From The Auction ${data.glId}-${data.customerName}`;
      body+=`Kindly hold the packet from the auction, as the customer is willing to do the payment.<br><br>`;
      break;
    case "Packet Availability Confirmation":
      subject=`Packet Availability Confirmation ${data.glId}-${data.customerName}`;
      body+=`Kindly confirm packet availability status for the below customer.<br><br>`;
      break;
    case "Customer Query for Auction Details":
      subject=`Customer Query for Auction Details ${data.glId}-${data.customerName}`;
      body+=`Customer has reached out requesting gold auction details. Kindly furnish details.<br><br>`;
      break;
    case "Customer Query For Auction Surplus":
      subject=`Customer Query For Auction Surplus ${data.glId}-${data.customerName}`;
      body+=`Customer ${data.customerName} requested auction surplus details. Kindly furnish.<br><br>`;
      break;
    case "Transfer of Surplus Amount To Customer":
      subject=`Transfer of Surplus Amount To Customer ${data.glId}-${data.customerName}`;
      body+=`Customer requested transfer of surplus amount. Kindly confirm.<br><br>`;
      break;
  }

  // Common details
  body+=`GL ID: ${data.glId}<br>Customer Name: ${data.customerName}<br>Customer Number: ${data.customerNumber}<br>Branch Name: ${data.branchName}<br>`;

  // Bank details
  if(data.mailType==="Transfer of Surplus Amount To Customer"){
    body+=`<br><b>Bank Details:</b><br>Bank A/C Number: ${data.bankAccount}<br>Bank Name: ${data.bankName}<br>IFSC Code: ${data.ifsc}<br>Supporting documents attached.<br>`;
  }
  return {subject, body};
}

// Form submit
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  errorMsg.textContent='';

  // Password check
  if(regards.value && password.value!==regardsPasswords[regards.value]){
    errorMsg.textContent="Incorrect password for selected Regards";
    return;
  }

  // Account detail validation
  if(!accountDetails.classList.contains('hidden')){
    const requiredFields=['bankAccount','bankName','ifsc','passbook'];
    for(const id of requiredFields){
      if(!document.getElementById(id).value){
        errorMsg.textContent="All account details are mandatory";
        return;
      }
    }
  }

  sendBtn.disabled=true; sendBtn.textContent="Sending...";

  try{
    const data={
      mailType: mailType.value,
      glId: document.getElementById('glId').value,
      customerName: customerNameInput.value,
      customerNumber: document.getElementById('customerNumber').value,
      branchName: branchNameInput.value,
      mappedEmail: mappedEmail.value,
      regards: regards.value,
      password: password.value
    };

    // Account + attachments
    if(!accountDetails.classList.contains('hidden')){
      data.bankAccount=document.getElementById('bankAccount').value;
      data.bankName=document.getElementById('bankName').value;
      data.ifsc=document.getElementById('ifsc').value;

      const passbookFile=document.getElementById('passbook').files[0];
      if(passbookFile) data.passbook=await fileToBase64(passbookFile); data.passbookType=passbookFile.type;

      const aadharFile=document.getElementById('aadhar').files[0];
      if(aadharFile) data.aadhar=await fileToBase64(aadharFile); data.aadharType=aadharFile.type;

      const panFile=document.getElementById('pan').files[0];
      if(panFile) data.pan=await fileToBase64(panFile); data.panType=panFile.type;
    }

    const emailContent=getEmailContent(data);
    data.subject=emailContent.subject;
    data.body=emailContent.body;

    // Call Apps Script
    const response=await fetch("https://script.google.com/macros/s/AKfycbzWipQXC0hHilW0HAfNNIUyv1gWcVe8M4LH6Ies2UaxZlWVwSnTaII-b7fHaB2hECC4/exec", {
      method:"POST",
      body:JSON.stringify(data)
    });
    const result=await response.json();
    if(result.status==="success"){
      alert("Mail sent successfully!");
      form.reset(); mappedEmail.value=''; accountDetails.classList.add('hidden');
    }else errorMsg.textContent=result.message;

  }catch(err){errorMsg.textContent=err.message;}

  sendBtn.disabled=false; sendBtn.textContent="Send Mail";
});
</script>
</body>
</html>